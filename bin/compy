#!/bin/bash

[ -n "$COMPOSER" ] || COMPOSER=composer

fail() {
    echo "$*" >&2
    exit 1
}

gen() {
    "$(dirname "$0")"/convert-config --quiet --force json-to-yaml composer.json compy.yml || fail "Could not generate your compy.yml file"
}

if [ -e compy.yml ]; then
    if [ composer.json -nt compy.yml ]; then
	mv compy.yml compy.yml~compy~ || fail "Could not backup your compy.yml to compy.yml~compy~"
	gen
	touch composer.json -r compy.yml
    fi
else
    gen
fi

if [ compy.yml -nt composer.json ]; then
    "$(dirname "$0")"/convert-config --quiet --force yaml-to-json compy.yml composer.json || fail "Could not generate your composer.json file"
fi
exec $COMPOSER "$@"
